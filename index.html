<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <script>
        (function() {
            const currentHost = window.location.hostname;
            const cfHost = 'aurora-project.pages.dev';
            const appHost = '12-six-topaz.vercel.app';

            if (currentHost === cfHost || currentHost === appHost || currentHost === 'localhost' || currentHost === '127.0.0.1') return;

            let redirected = false;

            function check(host) {
                return new Promise(r => {
                    const img = new Image();
                    img.onload = () => r(true);
                    img.onerror = () => r(false);
                    setTimeout(() => r(false), 2000); 
                    img.src = 'https://' + host + '/assets/img/avatar/penguin.png?t=' + Date.now();
                });
            }

            // Country Check
            fetch('https://api.country.is')
                .then(res => res.json())
                .then(data => {
                    if (data.country === 'CN' && !redirected) {
                        console.log('CN detected, forcing CF');
                        redirected = true;
                        window.location.href = 'https://' + cfHost + window.location.pathname + window.location.search + window.location.hash;
                    }
                })
                .catch(e => console.warn('Geo check failed', e));

            check(cfHost).then(isCfOk => {
                if (redirected) return;
                if (isCfOk) {
                    redirected = true;
                    window.location.href = 'https://' + cfHost + window.location.pathname + window.location.search + window.location.hash;
                } else {
                    check(appHost).then(isVercelOk => {
                        if (redirected) return;
                        if (isVercelOk) {
                            redirected = true;
                            window.location.href = 'https://' + appHost + window.location.pathname + window.location.search + window.location.hash;
                        } else {
                            document.addEventListener('DOMContentLoaded', () => {
                                const n = document.createElement('div');
                                n.style.cssText = 'position:fixed;top:0;left:0;width:100%;background:rgba(200,0,0,0.9);color:#fff;text-align:center;padding:5px;z-index:999999;font-size:12px;backdrop-filter:blur(5px);';
                                n.innerHTML = 'âš ï¸ ç½‘ç»œèŠ‚ç‚¹è¿æ¥å¤±è´¥ï¼Œå·²ä¿ç•™åœ¨ GitHub Pagesã€‚';
                                document.body.prepend(n);
                            });
                        }
                    });
                }
            });
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SINGABLE CHARACTER èˆ’è‹’ Aurora OFFICIAL SITE</title>
    <link rel="icon" href="assets/img/avatar/penguin.png" type="image/png">
    <link rel="stylesheet" href="style.css?v=6">
    <script src="assets/js/config.js"></script>
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <style>
        /* å†…è”Overlayæ ·å¼ä»¥é˜²CSSåŠ è½½å»¶è¿Ÿ */
        #agreement-overlay {
            display: none; /* é»˜è®¤éšè— */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 100000;
            overflow-y: auto;
            padding: 20px;
            justify-content: center;
            align-items: flex-start;
            backdrop-filter: blur(5px);
        }
        
        /* Search Box Styles */
        .logo-container { position: relative; }
        .search-box {
            display: flex;
            align-items: center;
            margin-left: 10px;
            overflow: hidden;
            width: 30px; /* Initial width (icon only) */
            transition: width 0.4s ease;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 5px;
        }
        .logo-container:hover .search-box, .search-box:focus-within {
            width: 200px; /* Expanded width */
            background: rgba(255,255,255,0.9);
        }
        .search-box input {
            border: none;
            background: transparent;
            outline: none;
            width: 100%;
            padding: 0 5px;
            font-size: 0.8rem;
            color: #000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .logo-container:hover .search-box input, .search-box:focus-within input {
            opacity: 1;
        }
        .search-icon {
            font-size: 1rem;
            cursor: pointer;
            min-width: 20px;
            text-align: center;
        }

        /* Dropdown Styles */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-content {
            display: none;
            position: fixed; /* Changed from absolute to fixed to escape all stacking contexts */
            background-color: #000;
            min-width: 140px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.5);
            z-index: 999999; /* Max z-index */
            border: 1px solid var(--accent-color, #00A86B);
            border-radius: 4px;
            overflow: hidden;
            /* Remove top/left/transform for now, will calculate with JS */
        }
        
        .dropdown:hover .dropdown-content {
            display: block;
        }
        
        .dropdown-content a {
            color: #fff !important;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            font-size: 0.8rem;
            white-space: nowrap;
            text-align: center;
            border-bottom: 1px solid #333;
        }
        
        .dropdown-content a:last-child {
            border-bottom: none;
        }
        
        .dropdown-content a:hover {
            background-color: var(--accent-color, #00A86B);
            color: #000 !important;
        }
        
        .dropdown:hover .dropdown-content {
            display: block;
        }
    </style>
</head>
<body>
            <!-- Video Overlay -->
    <div id="video-overlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:100005;justify-content:center;align-items:center;">
        <div style="position:relative;width:80%;max-width:800px;aspect-ratio:16/9;">
            <button onclick="closeVideo()" style="position:absolute;top:-40px;right:0;background:none;border:none;color:#fff;font-size:2rem;cursor:pointer;">&times;</button>
            <iframe id="yt-player" width="100%" height="100%" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
            </div>
    </div>

    <!-- Agreement Overlay -->
    <div id="agreement-overlay">
        <div class="agreement-container">
            <h1>é¡¹ç›®ä¼åˆ’åè®®</h1>

            <div class="agreement-section">
                <h3>å¼•è¨€</h3>
                <p>æœ¬åè®®æ—¨åœ¨æ˜ç¡®â€œAurora Projectâ€ï¼ˆä¸‹ç§°â€œæœ¬é¡¹ç›®â€ï¼‰ç›¸å…³æˆæœçš„æƒåˆ©å½’å±ã€ä½¿ç”¨è§„èŒƒåŠç®¡ç†è§„åˆ™ã€‚æ‰€æœ‰å‚ä¸æœ¬é¡¹ç›®çš„æˆå‘˜ï¼ˆä¸‹ç§°â€œç»„å†…æˆå‘˜â€æˆ–â€œæˆå‘˜â€ï¼‰å‡é¡»éµå®ˆæœ¬åè®®æ¡æ¬¾ã€‚é€šè¿‡å‚ä¸æœ¬é¡¹ç›®ï¼Œå³è¡¨ç¤ºæ‚¨å·²é˜…è¯»ã€ç†è§£å¹¶åŒæ„å—æœ¬åè®®çº¦æŸã€‚</p>
            </div>

            <div class="agreement-section">
                <h2>ä¸€ã€å®šä¹‰</h2>
                <p><strong>1.1 â€œæœ¬é¡¹ç›®â€ï¼š</strong>æŒ‡ç”±ç»„å†…æˆå‘˜å…±åŒåä½œå®Œæˆçš„åˆ›æ„æˆæœé›†åˆï¼ŒåŒ…æ‹¬ä½†ä¸é™äºæ–‡æœ¬ã€å›¾åƒã€ä»£ç ã€è®¾è®¡ã€éŸ³è§†é¢‘ç­‰å†…å®¹ã€‚</p>
                <p><strong>1.2 â€œç»„å†…æˆå‘˜â€ï¼š</strong>æŒ‡å®é™…å‚ä¸æœ¬é¡¹ç›®åˆ›ä½œã€è´¡çŒ®å†…å®¹å¹¶ç»ç°æœ‰æˆå‘˜è®¤å¯çš„æ‰€æœ‰ä¸ªäººã€‚</p>
                <p><strong>1.3 â€œé‡åº¦NSFWå†…å®¹â€ï¼š</strong>æŒ‡æ¶‰åŠæç«¯æš´åŠ›ã€è‰²æƒ…ã€éæ³•æ´»åŠ¨æˆ–å…¶ä»–å¯èƒ½å¯¹å…¬ä¼—äº§ç”Ÿå¼ºçƒˆä¸é€‚æˆ–é“å¾·åæ„Ÿçš„å†…å®¹ã€‚</p>
                <p><strong>1.4 â€œå•†ä¸šç”¨å‘â€ï¼š</strong>æŒ‡ä»¥è¥åˆ©ä¸ºç›®çš„ï¼ŒåŒ…æ‹¬é”€å”®ã€å¹¿å‘Šã€è®¸å¯æˆæƒç­‰ç›´æ¥æˆ–é—´æ¥è·å–ç»æµåˆ©ç›Šçš„è¡Œä¸ºã€‚</p>
            </div>

            <div class="agreement-section">
                <h2>äºŒã€æƒåˆ©å½’å±</h2>
                <h3>2.1 æ‰€æœ‰æƒ</h3>
                <p>æœ¬é¡¹ç›®æ‰€æœ‰æˆæœçš„çŸ¥è¯†äº§æƒåŠå…¶ä»–ç›¸å…³æƒåˆ©ç”±å…¨ä½“ç»„å†…æˆå‘˜å…±åŒäº«æœ‰ã€‚ä»»ä½•æˆå‘˜ä¸å¾—æ“…è‡ªå°†æœ¬é¡¹ç›®æˆæœç”¨äºä»¥ä¸‹ç”¨é€”ï¼š</p>
                <ul>
                    <li>åˆ¶ä½œã€ä¼ æ’­æˆ–åˆ©ç”¨é‡åº¦NSFWå†…å®¹ï¼›</li>
                    <li>ä»»ä½•å½¢å¼çš„å•†ä¸šç”¨å‘ï¼ˆé™¤éç»å…¨ä½“æˆå‘˜ä¹¦é¢åŒæ„ï¼‰ã€‚</li>
                </ul>

                <h3>2.2 ç½‘ç«™å½’å±æƒ</h3>
                <p>æœ¬é¡¹ç›®ç›¸å…³çš„ç½‘ç«™ï¼ˆåŒ…æ‹¬åŸŸåã€æœåŠ¡å™¨åŠç½‘ç«™å†…å®¹è½½ä½“ï¼‰çš„æœ€ç»ˆå½’å±æƒåŠæ§åˆ¶æƒå½’ <span class="highlight">â€œä¼é¹…ï¼ˆè´µæ—æœ‹å‹ï¼‰â€</span> æ‰€æœ‰ã€‚ç»„å†…æˆå‘˜å¯ä¾æœ¬åè®®ä½¿ç”¨ç½‘ç«™è¿›è¡Œé¡¹ç›®å±•ç¤ºä¸åä½œï¼Œä½†ä¸å¾—æœªç»è®¸å¯è½¬è®©ã€æŠµæŠ¼æˆ–ä»¥å…¶ä»–æ–¹å¼å¤„åˆ†ç½‘ç«™èµ„äº§ã€‚</p>

                <h3>2.3 ä¿®æ”¹æƒ</h3>
                <p>æœ¬é¡¹ç›®æˆæœçš„ä¿®æ”¹ã€æ›´æ–°ã€è¡ç”Ÿåˆ›ä½œç­‰æƒåˆ©ä»…é™ç»„å†…æˆå‘˜è¡Œä½¿ã€‚ä»»ä½•å¯¹å¤–éƒ¨çš„ä¿®æ”¹è®¸å¯é¡»ç»å…¨ä½“æˆå‘˜åå•†ä¸€è‡´ã€‚</p>
            </div>

            <div class="agreement-section">
                <h2>ä¸‰ã€ç®¡ç†åŠè§£é‡Š</h2>
                <p><strong>3.1 è§£é‡Šæƒï¼š</strong>æœ¬åè®®æ‰€æœ‰æ¡æ¬¾çš„è§£é‡Šæƒã€é€‚ç”¨æ€§åˆ¤å®šåŠæœªå°½äº‹å®œçš„è¡¥å……è§£é‡Šï¼Œå‡å½’ <span class="highlight">â€œAurora Projectâ€</span> æ‰€æœ‰ã€‚</p>
                <p><strong>3.2 äº‰è®®è§£å†³ï¼š</strong>å› æœ¬åè®®å¼•èµ·çš„äº‰è®®ï¼Œç»„å†…æˆå‘˜åº”ä¼˜å…ˆé€šè¿‡å†…éƒ¨åå•†è§£å†³ï¼›åå•†ä¸æˆçš„ï¼Œå¯ä¾â€œAurora Projectâ€ä½œå‡ºçš„è§£é‡Šä¸ºå‡†ã€‚</p>
            </div>

            <div class="agreement-section">
                <h2>å››ã€å…¶ä»–</h2>
                <p>4.1 æœ¬åè®®è‡ªå…¨ä½“ç»„å†…æˆå‘˜å‚ä¸æœ¬é¡¹ç›®æ—¶ç”Ÿæ•ˆã€‚</p>
                <p>4.2 å¦‚æœ‰æˆå‘˜é€€å‡ºæœ¬é¡¹ç›®ï¼Œå…¶åœ¨æœ¬åè®®ä¸‹çš„æƒåˆ©è‡ªåŠ¨ç»ˆæ­¢ï¼Œä½†å…¶å·²è´¡çŒ®éƒ¨åˆ†ä»å—æœ¬åè®®çº¦æŸã€‚</p>
                <p>4.3 æœ¬åè®®å†…å®¹å¯ç»å…¨ä½“æˆå‘˜åŒæ„åä¿®è®¢ï¼Œä¿®è®¢åç‰ˆæœ¬äº¦é¡»ä»¥ä¹¦é¢å½¢å¼ç¡®è®¤ã€‚</p>
            </div>

            <div class="agreement-footer">
                <p class="agreement-note">åè®®é˜…è¯»åä»£è¡¨ä½ å·²ç¡®è®¤</p>
                <button class="agreement-btn" onclick="document.getElementById('agreement-overlay').style.display='none'">æˆ‘å·²é˜…è¯»å¹¶ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <div id="promo-overlay">
        <div class="promo-content">
            <img src="assets/img/promo_popup.jpeg" alt="Promo" class="promo-img">
            <div style="display: flex; gap: 20px; justify-content: center; margin-top: 30px;">
                <button class="promo-btn" onclick="document.getElementById('promo-overlay').style.display='none'">æˆ‘çŸ¥é“äº†</button>
                <button class="promo-btn" id="disapprove-btn" style="background: #333; font-size: 0.8rem;">æˆ‘ä¸æ”¯æŒ</button>
            </div>
        </div>
    </div>

    <!-- Jump Scare Overlay -->
    <div id="jumpscare-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:100001; background:#000;">
        <img src="assets/img/jumpscare.png" style="width:100%; height:100%; object-fit:cover;">
    </div>

    <div id="flashlight-overlay"></div>

    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <style>
        /* Login Styles */
        .auth-container { text-align: left; }
        .auth-step { display: none; animation: fadeIn 0.3s; }
        .auth-step.active { display: block; }
        .auth-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; background: #f9f9f9; }
        .auth-btn { width: 100%; padding: 12px; background: #000; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .auth-btn:disabled { background: #ccc; cursor: not-allowed; }
        .avatar-preview { width: 80px; height: 80px; border-radius: 50%; background: #eee; margin: 0 auto 15px; overflow: hidden; display: flex; justify-content: center; align-items: center; border: 2px solid var(--accent-color); cursor: pointer; }
        .avatar-preview img { width: 100%; height: 100%; object-fit: cover; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }
    </style>

    <!-- Search Results Overlay -->
    <div id="search-results-overlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:100004;justify-content:center;align-items:center;backdrop-filter:blur(5px);">
        <div style="background:#fff;padding:20px;border-radius:16px;width:350px;max-height:80vh;overflow-y:auto;position:relative;">
            <button onclick="document.getElementById('search-results-overlay').style.display='none'" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:1.5rem;cursor:pointer;">&times;</button>
            <h3 style="margin-bottom:15px;">æœç´¢ç»“æœ</h3>
            <div id="search-results-list" style="display:flex;flex-direction:column;gap:10px;"></div>
        </div>
    </div>

    <!-- Profile Overlay -->
    <div id="profile-overlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:100003;justify-content:center;align-items:center;backdrop-filter:blur(5px);">
        <div id="profile-card-container" class="profile-card theme-default" style="padding:30px;border-radius:16px;width:350px;position:relative;background:#fff;">
            <button onclick="document.getElementById('profile-overlay').style.display='none'" style="position:absolute;top:15px;right:15px;background:none;border:none;font-size:1.5rem;cursor:pointer;z-index:10;">&times;</button>
            
            <div style="text-align:center;">
                <div class="avatar-preview" style="margin: 0 auto 15px; cursor: default;">
                    <img id="profile-avatar" src="assets/img/avatar/penguin.png">
                </div>
                <h3 id="profile-username" style="margin-bottom:5px;">User</h3>
                <p id="profile-email" style="font-size:0.8rem;color:#999;margin-bottom:5px;">email@example.com</p>
                <p id="profile-points" style="font-size:0.9rem;color:var(--accent-color);font-weight:bold;margin-bottom:20px;">ğŸ’ ç§¯åˆ†: 0</p>
                
                <!-- Theme Selector -->
                <div class="theme-selector">
                    <div class="theme-option active" data-theme="default" onclick="selectTheme('default')" title="é»˜è®¤ / Default"></div>
                    <div class="theme-option" data-theme="aurora" onclick="selectTheme('aurora')" title="ç¿¡ç¿ ç»¿ / Aurora"></div>
                    <div class="theme-option" data-theme="dark" onclick="selectTheme('dark')" title="æš—å¤œ / Dark"></div>
                    <div class="theme-option" data-theme="vip" onclick="selectTheme('vip')" title="å°Šè´µé‡‘ / VIP"></div>
                </div>
                
                <div style="text-align:left; margin-bottom: 20px;">
                    <label style="font-size:0.8rem;font-weight:bold;">Bio / ç®€ä»‹</label>
                    <textarea id="profile-bio" class="auth-input" style="height:60px;resize:none;"></textarea>
                    
                    <label style="font-size:0.8rem;font-weight:bold;">Username / æ˜µç§°</label>
                    <input type="text" id="profile-username-input" class="auth-input">
                </div>

                <button onclick="updateProfile()" class="auth-btn" style="background:var(--accent-color);margin-bottom:10px;">ä¿å­˜ä¿®æ”¹ / SAVE</button>
                <button onclick="logout()" class="auth-btn" style="background:#333;">é€€å‡ºç™»å½• / LOGOUT</button>
            </div>
        </div>
    </div>

    <!-- Login Overlay -->
    <div id="login-overlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:100002;justify-content:center;align-items:center;backdrop-filter:blur(5px);">
        <div style="background:#fff;padding:30px;border-radius:16px;width:350px;box-shadow:0 10px 40px rgba(0,0,0,0.3);position:relative;">
            <button onclick="document.getElementById('login-overlay').style.display='none'" style="position:absolute;top:15px;right:15px;background:none;border:none;font-size:1.5rem;cursor:pointer;">&times;</button>
            
            <h3 style="margin-bottom:10px; font-size: 1.5rem;">æ¬¢è¿æ¥åˆ° Aurora Project</h3>
            <p style="font-size:0.9rem;color:#666;margin-bottom:25px;">è¯·éªŒè¯æ‚¨çš„èº«ä»½ä»¥ç»§ç»­ã€‚</p>
            
            <div class="auth-container">
                <!-- Step 1: Email & Turnstile -->
                <div id="login-step-1" class="auth-step active">
                    <input type="email" id="login-email" class="auth-input" placeholder="ç”µå­é‚®ç®±åœ°å€ (Email)">
                    <!-- Cloudflare Turnstile (Production Key) -->
                    <div class="cf-turnstile" data-sitekey="0x4AAAAAACNkBeCjs7ELcZzO" data-callback="onTurnstileSuccess" style="margin-bottom: 15px; min-height: 65px;"></div>
                    <button onclick="requestLoginCode()" class="auth-btn" id="btn-send-code">è·å–éªŒè¯ç </button>
                </div>

                <!-- Step 2: Verify Code -->
                <div id="login-step-2" class="auth-step">
                    <p style="font-size:0.9rem;margin-bottom:15px;">éªŒè¯ç å·²å‘é€è‡³ <b id="email-display"></b></p>
                    <input type="text" id="login-code" class="auth-input" placeholder="6ä½æ•°å­—éªŒè¯ç " style="text-align:center;letter-spacing:5px;font-size:1.2rem;">
                    <button onclick="submitLoginCode()" class="auth-btn" style="background:var(--accent-color);">ç™»å½• / Login</button>
                    <div style="text-align:center;margin-top:10px;"><a href="#" onclick="resetLogin()" style="font-size:0.8rem;color:#999;">æ›´æ¢é‚®ç®±</a></div>
                </div>

                <!-- Step 3: Register Profile -->
                <div id="login-step-3" class="auth-step">
                    <h4 style="text-align:center;margin-bottom:15px;">å®Œå–„æ‚¨çš„èµ„æ–™</h4>
                    
                    <div class="avatar-preview" onclick="document.getElementById('reg-avatar').click()">
                        <img id="avatar-img" src="assets/img/avatar/penguin.png">
                    </div>
                    <input type="file" id="reg-avatar" accept="image/*" style="display:none" onchange="previewAvatar(this)">
                    <p style="text-align:center;font-size:0.8rem;color:#999;margin-bottom:15px;">ç‚¹å‡»ä¸Šä¼ å¤´åƒ</p>

                    <input type="text" id="reg-username" class="auth-input" placeholder="æ˜µç§° / Username">
                    <input type="text" id="reg-bio" class="auth-input" placeholder="ä¸€å¥è¯ç®€ä»‹ / Bio">
                    
                    <button onclick="completeRegistration()" class="auth-btn" style="background:var(--accent-color);">å®Œæˆæ³¨å†Œ</button>
                </div>
            </div>
            
            <p id="login-msg" style="margin-top:15px;font-size:0.8rem;color:red;text-align:center;min-height:1.2em;"></p>
        </div>
    </div>

    <!-- Sidebar Overlay -->
    <div id="sidebar-overlay">
        <div class="sidebar-header">
            <h3>æŠ•ç¨¿ / SUBMIT FANART</h3>
            <button class="close-sidebar-btn" onclick="toggleSidebar()">Ã—</button>
        </div>
        <div class="sidebar-content">
            <p style="margin-bottom: 20px; font-size: 0.9rem; color: #666;">æ¬¢è¿å‘ Aurora Project æŠ•ç¨¿åŒäººä½œå“ï¼æ‚¨çš„ä½œå“å¯èƒ½ä¼šè¢«å±•ç¤ºåœ¨ Fanart é¡µé¢ã€‚</p>
            
            <form id="fanart-form" onsubmit="handleFanartSubmit(event)">
                <div class="sidebar-form-group">
                    <label>æ˜µç§° / Name</label>
                    <input type="text" placeholder="æ‚¨çš„ç§°å‘¼" required>
                </div>
                
                <div class="sidebar-form-group">
                    <label>ä½œå“æ ‡é¢˜ / Title</label>
                    <input type="text" placeholder="ä½œå“æ ‡é¢˜">
                </div>

                <div class="sidebar-form-group">
                    <label>ä½œå“æ–‡ä»¶ / File</label>
                    <input type="file" accept="image/*" required>
                </div>

                <div class="sidebar-form-group">
                    <label>ç•™è¨€ / Comment</label>
                    <textarea placeholder="æƒ³å¯¹ Aurora è¯´çš„è¯..."></textarea>
                </div>

                <button type="submit" class="submit-btn">æäº¤ / SUBMIT</button>
            </form>
        </div>
    </div>

    <div class="loading-screen" id="loadingScreen">
        <div class="loader"></div>
    </div>

    <nav class="navbar">
        <div class="logo-container" style="display:flex; align-items:center;">
            <div class="logo" onclick="toggleSidebar()">èˆ’è‹’ AURORA</div>
            <div class="search-box">
                <input type="text" id="user-search-input" placeholder="æœç´¢ç”¨æˆ·..." onkeypress="handleUserSearch(event)">
                <span class="search-icon">ğŸ”</span>
            </div>
        </div>
        <div class="nav-links" tabindex="0" aria-label="Navigation Menu">
            <a href="index.html#home">TOP</a>
            <a href="news_paper.html">NEWS</a>
            <a href="index.html#profile">CHARACTER</a>
            <a href="index.html#story">STORY</a>
            <a href="index.html#credits">CREDITS</a>
            <a href="qa.html">Q&A</a>
            <a href="staff_oc.html">STAFF OC</a>
            <a href="index.html#join">JOIN</a>
            <a href="#" onclick="document.getElementById('agreement-overlay').style.display='flex'; return false;">AGREEMENT</a>
            <a href="fanart.html">FANART</a>
            <a href="monitor.html" style="color: var(--accent-color);">MONITOR</a>
            <div class="dropdown">
                <a href="javascript:void(0)" style="color: #e60012; cursor: pointer;">GAME â–¾</a>
                <div class="dropdown-content">
                    <a href="wiki_wagou.html">ç¥äºº Wiki</a>
                    <a href="ç“¦ç‹—97.html">è¿›å…¥æ¸¸æˆ (æ—§ç‰ˆ)</a>
                    <a href="game_rinny/index.html">Rinny Date (Web)</a>
                    <a href="https://cloud1-0gk4vuldb9fdffc8-1395284226.tcloudbaseapp.com" target="_blank">Rinny Date (å®˜ç½‘)</a>
                </div>
            </div>
            <a href="#" onclick="openProfile(); return false;" id="nav-user-link">LOGIN</a>
            <div class="flashlight-toggle" id="flashlight-toggle"><span>ğŸ”¦ OFF</span></div>
        </div>
        <!-- Scroll Progress Bar -->
        <div class="scroll-progress-container">
            <div class="scroll-progress-bar" id="scrollProgressBar"></div>
        </div>
    </nav>

            <section id="home" class="hero-section">
                <div class="hero-bg-text">AURORA</div>
        
        <div class="hero-info">
            <span class="sub-title">Jewelry Designer & Emerald</span>
            <h2 class="main-title">èˆ’è‹’<br><span>Aurora</span></h2>
            <p style="margin-bottom: 30px; font-weight: 500;">æ˜¥å­£ç›ç„¶è€Œåˆæ¸©æŸ”ä½“è´´ï¼Œå†…å¿ƒå¼ºå¤§åšéŸ§<br>18 Years Old / Green Emerald</p>
            <a href="#profile" class="hero-btn">View Profile</a>
        </div>

                <div class="character-visual">
            <img src="assets/img/character_full.png" alt="Aurora Character" class="character-img" onerror="this.style.display='none';">
                    </div>
    </section>

    <section id="news" class="content-section">
        <h2 class="section-title">NEWS</h2>
        <div class="qa-container" style="max-width: 100%;">
            <div class="qa-item" style="display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1;">
                    <span style="color: var(--accent-color); font-weight: 900; margin-right: 15px;">2026.01.11</span>
                    <span style="background: #000; color: #fff; padding: 2px 8px; font-size: 12px; margin-right: 10px;">INFO</span>
                    <a href="#" style="text-decoration: none; color: #000; font-weight: 700;">èˆ’è‹’å®˜æ–¹å®£ä¼ ç½‘é¡µå…¬å¼€ï¼</a>
                </div>
                </div>
            <div class="qa-item" style="display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1;">
                    <span style="color: var(--accent-color); font-weight: 900; margin-right: 15px;">2026.01.11</span>
                    <span style="background: var(--accent-color); color: #fff; padding: 2px 8px; font-size: 12px; margin-right: 10px;">CHARA</span>
                    <a href="#" style="text-decoration: none; color: #000; font-weight: 700;">è§’è‰²ç«‹ç»˜æ­£åœ¨ç´§é”£å¯†é¼“åˆ¶ä½œä¸­ï¼Œæ•¬è¯·æœŸå¾…ã€‚</a>
                </div>
                    </div>
                </div>
            </section>

    <section id="profile" class="content-section">
        <h2 class="section-title">CHARACTER</h2>
        
        <div class="wiki-container">
            <!-- Wiki Header -->
            <div class="wiki-header">
                <h1 class="wiki-title">èˆ’è‹’</h1>
                <div class="wiki-meta">Aurora / ç¿¡ç¿ ç»¿ / 18å²</div>
                </div>

            <div class="wiki-content-wrapper">
                <!-- Main Content -->
                <div class="wiki-main-text">
                    <div class="wiki-intro">
                        <p><strong>èˆ’è‹’</strong> (Aurora)ï¼Œæ˜¯Aurora Projectä¼åˆ’çš„æ ¸å¿ƒè§’è‰²ã€‚ä½œä¸ºä¸€å18å²çš„ç å®è®¾è®¡å¸ˆï¼Œå¥¹ä»¥å…¶ç‹¬ç‰¹çš„å®¡ç¾å’ŒåšéŸ§çš„æ€§æ ¼é—»åã€‚å¥¹çš„ä»£è¡¨è‰²ä¸º<span style="color:var(--accent-color)">ç¿¡ç¿ ç»¿ (Emerald Green)</span>ã€‚</p>
                        <p>å¥¹å‡ºèº«å¯Œè´µï¼Œå´ä¸å› ä¼˜æ¸¥çš„ç¯å¢ƒè€Œéª„çºµã€‚åœ¨å¤æ‚çš„å®¶æ—æ–—äº‰ä¸­ï¼Œå¥¹å±•ç°å‡ºäº†è¶…ä¹å¹´é¾„çš„æˆç†Ÿä¸ç†æ™ºã€‚å¥¹ä¸ä»…åœ¨ç å®è®¾è®¡é¢†åŸŸé€ è¯£é¢‡æ·±ï¼Œæ›´æ˜¯ä¸€ä½çƒ­çˆ±ç”Ÿæ´»çš„å›­è‰ºèŒ¶é…¿å¸ˆã€‚</p>
                </div>

                    <div class="wiki-toc">
                        <div class="wiki-toc-title">ç›®å½•</div>
                        <ul>
                            <li><a href="#wiki-appearance">1 å¤–è²Œè®¾å®š</a></li>
                            <li><a href="#wiki-personality">2 æ€§æ ¼ç‰¹å¾</a></li>
                            <li><a href="#wiki-trivia">3 çäº‹ä¸å–œå¥½</a></li>
                        </ul>
                        </div>

                    <h3 id="wiki-appearance" class="wiki-section-header">å¤–è²Œè®¾å®š</h3>
                    <p>èˆ’è‹’æ‹¥æœ‰æ ‡å¿—æ€§çš„æ·¡é»„è‰²é•¿å‘ï¼Œé€šå¸¸æ¢³æˆä¾§è¾¹ä¸¸å­å¤´ï¼Œè¿™å·²æˆä¸ºå¥¹çš„è§†è§‰ç¬¦å·ä¹‹ä¸€ã€‚å¤´é¡¶çš„ä¸€å¯¹ç™½è‰²å…”è€³ä¸ä»…å¢æ·»äº†å¯çˆ±æ„Ÿï¼Œæ›´æš—ç¤ºäº†å¥¹æ•é”çš„æ„ŸçŸ¥åŠ›ã€‚</p>
                    <p>å¥¹çš„ç³å­”å‘ˆç°å‡ºå¦‚åŒä¸Šç­‰ç¥–æ¯ç»¿å®çŸ³èˆ¬çš„é€šé€ç»¿è‰²ï¼Œçœ¼ç¥ä¸­å¸¸å«ç€æ¸©æŸ”å´ä¸å¤±å¨ä¸¥çš„å…‰èŠ’ã€‚åœ¨æœé¥°ä¸Šï¼Œå¥¹åçˆ±éœ²è‚©ç¼é¢æè´¨çš„å¢¨ç»¿è‰²é•¿è£™ï¼Œæ­é…çç ä¸²æˆçš„ç¥–æ¯ç»¿é¡¹é“¾ï¼Œå½°æ˜¾å…¶é«˜è´µå…¸é›…çš„æ°”è´¨ã€‚å¤´ä¸Šå¸¸è£…é¥°æœ‰èŒ‰è‰èŠ±å…ƒç´ çš„å¤§è´è¶ç»“ï¼Œè±¡å¾ç€å¥¹å¯¹è‡ªç„¶çš„å–œçˆ±ã€‚</p>

                    <h3 id="wiki-personality" class="wiki-section-header">æ€§æ ¼ç‰¹å¾</h3>
                    <ul>
                        <li><strong>ç‹¬ç«‹åšéŸ§</strong>ï¼šæ— è®ºé¢å¯¹å®¶æ—çº·äº‰è¿˜æ˜¯åˆ›ä½œç“¶é¢ˆï¼Œå¥¹æ€»èƒ½ç‹¬è‡ªå¯»æ‰¾å‡ºè·¯ã€‚</li>
                        <li><strong>æ¸©æŸ”ç†æ™º</strong>ï¼šå¯¹å¾…ä»–äººæ€»æ˜¯æ¸©æŸ”ä½“è´´ï¼Œä½†å¤„ç†é—®é¢˜æ—¶å´å¼‚å¸¸å†·é™å®¢è§‚ã€‚</li>
                        <li><strong>é€‚åº¦å‚²æ…¢</strong>ï¼šä½œä¸ºé¡¶çº§è®¾è®¡å¸ˆå’Œè´µæ—ï¼Œå¥¹æœ‰ç€å±äºè‡ªå·±çš„éª„å‚²ï¼Œä½†è¿™å¹¶ä¸ä»¤äººåæ„Ÿã€‚</li>
                    </ul>

                    <h3 id="wiki-trivia" class="wiki-section-header">çäº‹ä¸å–œå¥½</h3>
                    <div class="wiki-trivia-box">
                        <p>å¥¹å¯¹äº<strong>åç¾çš„æ‰‡å­</strong>æœ‰ç€è¿‘ä¹åæ‰§çš„å–œçˆ±ï¼Œæ”¶è—äº†ä¸Šç™¾æŠŠä¸åŒå·¥è‰ºçš„æŠ˜æ‰‡ã€‚é—²æš‡æ—¶å…‰ï¼Œå¥¹å–œæ¬¢å“å°<strong>é’è‹¹æœ</strong>ï¼Œé‚£ç§é…¸ç”œæ¸…è„†çš„å£æ„Ÿèƒ½å¸¦ç»™å¥¹çµæ„Ÿã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå¥¹æœ€æ“…é•¿çš„å¹¶éè®¾è®¡ï¼Œè€Œæ˜¯<strong>ç®¡ç†çäº‹ä¸è§£å†³éº»çƒ¦</strong>ï¼Œè¿™æˆ–è®¸æºäºå¥¹ä»å°åœ¨å¤§å®¶æ—ä¸­ç»ƒå°±çš„ç”Ÿå­˜æŠ€èƒ½ã€‚</p>
                        </div>
                        </div>

                <!-- InfoBox (Right Side) -->
                <div class="wiki-infobox">
                    <div class="infobox-title">èˆ’è‹’ (Aurora)</div>
                    <div class="infobox-image">
                        <img src="assets/img/character_full.png" alt="Aurora Portrait">
                        <div class="infobox-caption">è§’è‰²ç«‹ç»˜</div>
                        </div>
                    <table class="infobox-data">
                        <tr>
                            <th>æœ¬å</th>
                            <td>èˆ’è‹’</td>
                        </tr>
                        <tr>
                            <th>å¤–æ–‡å</th>
                            <td>Aurora</td>
                        </tr>
                        <tr>
                            <th>å¹´é¾„</th>
                            <td>18å²</td>
                        </tr>
                        <tr>
                            <th>ä»£è¡¨è‰²</th>
                            <td><span style="color:var(--accent-color)">â– </span> ç¿¡ç¿ ç»¿</td>
                        </tr>
                        <tr>
                            <th>èŒä¸š</th>
                            <td>ç å®è®¾è®¡å¸ˆ<br>å›­è‰ºèŒ¶é…¿å¸ˆ</td>
                        </tr>
                        <tr>
                            <th>èŒç‚¹</th>
                            <td>å…”è€³ã€ä¾§ä¸¸å­å¤´ã€å¤§å°å§</td>
                        </tr>
                        <tr>
                            <th>å–œå¥½</th>
                            <td>æ‰‡å­ã€å®çŸ³ã€é’è‹¹æœ</td>
                        </tr>
                    </table>
                        </div>
                    </div>
                </div>
            </section>


    <section id="story" class="content-section" style="background: #f4f4f4;">
        <h2 class="section-title">STORY</h2>
        <div class="qa-container">
            <div class="qa-item">
                <div class="question" style="margin-bottom: 10px;">èƒŒæ™¯æ•…äº‹ / BACKGROUND STORY</div>
                <div class="answer" style="border-top: none;">
                    <p style="margin-bottom: 15px;">èˆ’è‹’å‡ºèº«å¯Œè´µä¹‹å®¶ï¼Œå®¶æ—ç²¾é€šè‰ºæœ¯å´å……æ»¡å‹¾å¿ƒæ–—è§’ã€‚åœ¨è¿™æ ·çš„ç¯å¢ƒä¸­ï¼Œå¥¹è‡ªå¹¼ä¾¿æ˜ç™½â€œæƒ³è¦çš„ä¸€åˆ‡åªèƒ½é è‡ªå·±â€ã€‚å°½ç®¡çˆ¶æ¯å¸Œæœ›å¥¹ç»§æ‰¿å“²å­¦äº‹ä¸šï¼Œå¥¹å´æ€€æ£ç€å¯¹ç å®è®¾è®¡çš„æ— é™çƒ­çˆ±ã€‚</p>
                    <p style="margin-bottom: 15px;">é¢å¯¹å®¶æ—çš„å‹åŠ›ï¼Œå¥¹åœ¨æˆ¿é—´è´´æ»¡äº†è®¾è®¡å›¾çº¸ï¼Œé‚£æ˜¯å¥¹æ— å£°çš„æŠ—äº‰ä¸æ¢¦æƒ³ã€‚å¥¹æ·±çŸ¥ï¼Œå¦‚æœä¸é¡ºä»çˆ¶æ¯ï¼Œè¿è¿½æ¢¦çš„æœºä¼šéƒ½å°†å¤±å»ã€‚äºæ˜¯ï¼Œå¥¹ä¸€è¾¹ç»´æŒç€è±ªé—¨åƒé‡‘çš„å®Œç¾å½¢è±¡ï¼Œç¤¼æ•°è§„çŸ©æ ·æ ·ç²¾é€šï¼›ä¸€è¾¹åœ¨æ·±å¤œé‡Œæ‰“ç£¨æŠ€è‰ºï¼Œç”¨å®åŠ›è¯æ˜è‡ªå·±ã€‚</p>
                    
                    <p style="margin-bottom: 20px; font-weight: 900; font-size: 1.2rem; color: var(--accent-color); text-align: center; border-left: 3px solid var(--accent-color); padding-left: 15px; margin-left: 0;">â€œæˆ‘æƒ³è¦çš„ä¸€åˆ‡éƒ½ä¼šæ…¢æ…¢è‡ªå·±æ‹¥æœ‰ï¼Œåªè¦æˆ‘éœ€è¦ã€‚â€</p>
                    
                    <p style="margin-bottom: 15px;">å¦‚ä»Šï¼Œ18å²çš„å¥¹å·²å‡­å€Ÿå¤©èµ‹ä¸åŠªåŠ›ï¼Œæˆä¸ºå¤‡å—èµèª‰çš„ç å®è®¾è®¡å¸ˆï¼Œæ‹¥æœ‰äº†å±äºè‡ªå·±çš„åº„å›­ã€‚é—²æš‡æ—¶ï¼Œå¥¹åŒ–èº«å›­è‰ºèŒ¶é…¿å¸ˆï¼Œåœ¨é˜³å…‰ä¸‹äº«å—ç‰‡åˆ»æ…µæ‡’ã€‚</p>
                    <p>å¥¹è§è¿‡ä¸–é—´ç™¾æ€ï¼Œæ·±çŸ¥ç”Ÿæ´»çš„ä¸æ˜“ã€‚å› æ­¤ï¼Œå¥¹è™½èº«ä¸ºå°Šè´µçš„åº„å›­å¥³ä¸»äººï¼Œå´æ¯«æ— éª„çºµä¹‹æ°”ï¼Œæ€»æ˜¯çƒ­å¿ƒå¸®åŠ©æ¯ä¸€ä¸ªéœ€è¦æ´æ‰‹çš„äººï¼Œæ— è®ºæ˜¯è´µæ—è¿˜æ˜¯å¹³æ°‘ã€‚åœ¨å¤§å®¶çœ¼ä¸­ï¼Œå¥¹æ—¢æ˜¯é‚£ä½å†…å¿ƒå¼ºå¤§ã€æ¸¸åˆƒæœ‰ä½™çš„â€œå¤§å°å§â€ï¼Œä¹Ÿæ˜¯é‚£ä½æ¸©æŸ”ä½“è´´ã€å¶å°”æµéœ²å°‘å¥³å¿ƒäº‹çš„é‚»å®¶å¥³å­©ã€‚</p>
                </div>
            </div>
        </div>
    </section>

    <section id="credits" class="content-section">
        <h2 class="section-title">CREDITS</h2>
        
        <h3 style="margin-bottom: 30px; font-weight: 900;">SPECIAL THANKS</h3>
        <div class="staff-grid">
            <div class="staff-card">
                <div class="staff-img-container">
                    <img src="assets/img/avatar/kawako.png" alt="kawako" onerror="this.src='assets/img/placeholder.png'">
                </div>
                <div class="staff-info">
                    <h3>kawako</h3>
                    <p>CREATOR</p>
                        </div>
                    </div>
            
            <div class="staff-card">
                <div class="staff-img-container">
                    <img src="assets/img/avatar/penguin.png" alt="ä¼é¹…" onerror="this.src='assets/img/placeholder.png'">
                        </div>
                <!-- Link to Penguin Video -->
                <div class="staff-info" style="cursor: pointer;" onclick="openVideo('BV1F2hqzvEtw')" title="ç‚¹å‡»æ’­æ”¾ (çƒ§é…’æ­Œ)">
                    <h3>ä¼é¹…</h3>
                    <p>SUPPORTER & WEB</p>
                    <small style="display:block; margin-top:5px; color:#666;">QQ: 2815918449</small>
                    </div>
                        </div>
                    </div>

        <h3 style="margin: 60px 0 30px; font-weight: 900;">STAFF LIST</h3>
        <div class="staff-grid" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));">
            <div class="staff-card" style="padding: 20px;">
                <div style="font-weight: 900; font-size: 1.2rem;">é»‘ç³</div>
                <p style="color: var(--accent-color); font-size: 0.8rem; font-weight: 700;">STAFF</p>
                        </div>
            <div class="staff-card" style="padding: 20px;">
                <div style="font-weight: 900; font-size: 1.2rem;">é«˜é’™</div>
                <p style="color: var(--accent-color); font-size: 0.8rem; font-weight: 700;">STAFF / CV</p>
                    </div>
            <div class="staff-card" style="padding: 20px;">
                <div style="font-weight: 900; font-size: 1.2rem;">çº¢è‰²ä¹’ä¹“çƒ</div>
                <p style="color: var(--accent-color); font-size: 0.8rem; font-weight: 700;">STAFF</p>
                    </div>
                </div>
            </section>

    <section id="join" class="content-section" style="background: #000; color: #fff;">
        <h2 class="section-title" style="color: #fff; border-bottom-color: #fff;">PROJECT JOIN</h2>
        
        <div style="display: flex; flex-wrap: wrap; gap: 50px; margin-top: 40px;">
            <div style="flex: 1; min-width: 300px;">
                <h3 style="font-size: 1.8rem; margin-bottom: 20px;">ä¼åˆ’ç¾¤ï¼šæ¬¢è¿æœ‰åˆ›æ„çš„äººå‰æ¥</h3>
                <p style="opacity: 0.8; margin-bottom: 30px;">æœ¬ä¼åˆ’æ—¨åœ¨å…±åˆ›ä¸€ä¸ªåŸåˆ›è§’è‰²ï¼Œæˆ‘ä»¬æ¯ä¸ªäººè¿ç»­ç»™å®ƒè¡¥è®¾å®šç­‰ï¼Œåœ¨è¿™é‡Œï¼Œä½ å¯ä»¥å‘æŒ¥ä½ æœ€å¤§çš„æƒ³è±¡ä¸åˆ›æ„ï¼</p>
                        
                <ul style="list-style: none; border-left: 2px solid var(--accent-color); padding-left: 20px;">
                    <li style="margin-bottom: 15px;"><strong>âœ¦ åŸåˆ›è§’è‰²å…±åˆ›</strong><br><span style="opacity:0.7">æ¯ä¸ªäººè¿ç»­ä¸ºè§’è‰²è¡¥å…¨è®¾å®šã€ç«‹ç»˜ç­‰ã€‚</span></li>
                    <li style="margin-bottom: 15px;"><strong>âœ¦ æ°‘ä¸»æŠ•ç¥¨</strong><br><span style="opacity:0.7">è·å¾—è®¤å¯å³å¯ä¿ç•™è®¾å®šã€‚</span></li>
                    <li style="margin-bottom: 15px;"><strong>âœ¦ å…±åŒæŠšå…»</strong><br><span style="opacity:0.7">å®ƒæ˜¯å±äºå¤§å®¶çš„åŸåˆ›è§’è‰²ã€‚</span></li>
                            </ul>

                <div style="margin-top: 40px; border: 2px solid #fff; padding: 20px; display: inline-flex; align-items: center; gap: 20px;">
                    <img src="assets/img/promo_bg.png" alt="QR" style="width: 80px; height: 80px; background: #fff;">
                    <div>
                        <div style="font-weight: 700;">æ‰«ç åŠ å…¥ä¼åˆ’ç¾¤</div>
                        <div style="font-size: 0.8rem; opacity: 0.7;">æ— é—¨æ§› / è‡ªç”±æ‰©å±•</div>
                        </div>
                    </div>
                    </div>
            
            <div style="flex: 1; min-width: 300px;">
                <img src="assets/img/promo_join.png" alt="Join Promo" style="width: 100%; border: 2px solid #fff; box-shadow: 10px 10px 0px var(--accent-color);">
                    </div>
                </div>
            </section>

    <footer>
        <p>&copy; 2026 Aurora Project ä¼åˆ’é¡¹ç›®ç»„. ä¿ç•™æ‰€æœ‰æƒåˆ©.</p>
        <p style="font-size: 0.8rem; margin-top: 5px; opacity: 0.8;">Live2D Model by @æ–‡å­¦éƒ¨çš„404</p>
    </footer>

    <script>
        // Dropdown Position Fix
        document.addEventListener('DOMContentLoaded', () => {
            const dropdowns = document.querySelectorAll('.dropdown');
            
            dropdowns.forEach(dd => {
                const content = dd.querySelector('.dropdown-content');
                let timeout; // Add delay timer

                const show = () => {
                    clearTimeout(timeout);
                    const rect = dd.getBoundingClientRect();
                    content.style.display = 'block';
                    content.style.top = (rect.bottom) + 'px'; // Removing gap to make it easier to enter
                    content.style.left = (rect.left + (rect.width / 2) - (content.offsetWidth / 2)) + 'px';
                };

                const hide = () => {
                    timeout = setTimeout(() => {
                        content.style.display = 'none';
                    }, 300); // 300ms delay before hiding
                };

                // Trigger on parent
                dd.addEventListener('mouseenter', show);
                dd.addEventListener('mouseleave', hide);
                
                // Keep showing if hovering the content itself
                content.addEventListener('mouseenter', () => clearTimeout(timeout));
                content.addEventListener('mouseleave', hide);
            });
        });

        window.addEventListener('load', () => {
            const loader = document.getElementById('loadingScreen');
            // ç®€å•çš„æ·¡å‡ºé€»è¾‘
            setTimeout(() => {
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.style.display = 'none';
                    
                    // Trigger Promo Animation after loading screen is gone
                    const promoOverlay = document.getElementById('promo-overlay');
                    const promoImg = document.querySelector('.promo-img');
                    const promoBtn = document.querySelector('.promo-btn');
                    
                    promoOverlay.style.display = 'flex';
                    // Small delay to ensure display:flex is rendered before adding class
                    setTimeout(() => {
                        promoImg.classList.add('animate');
                        // Animate both buttons
                        document.querySelectorAll('.promo-btn').forEach(btn => btn.classList.add('animate'));
                    }, 100);

                }, 500);
            }, 1000);
        });

        // Jump Scare Logic
        document.getElementById('disapprove-btn').addEventListener('click', async () => {
            const jumpscare = document.getElementById('jumpscare-overlay');
            jumpscare.style.display = 'block';

            // 1. Audio: Web Audio API for generating Screech (High pitch noise)
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (AudioContext) {
                const audioCtx = new AudioContext();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.type = 'sawtooth'; // Harsh wave
                oscillator.frequency.setValueAtTime(1000, audioCtx.currentTime);
                // Frequency sweep up and down rapidly
                oscillator.frequency.exponentialRampToValueAtTime(8000, audioCtx.currentTime + 0.1);
                oscillator.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.2);
                
                // LFO for vibrato
                const lfo = audioCtx.createOscillator();
                lfo.type = 'square';
                lfo.frequency.value = 50; // Fast oscillation
                const lfoGain = audioCtx.createGain();
                lfoGain.gain.value = 2000;
                lfo.connect(lfoGain);
                lfoGain.connect(oscillator.frequency);
                lfo.start();

                gainNode.gain.value = 1.0; // Max volume
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.start();
                
                // Stop audio after 5 seconds
                setTimeout(() => {
                    oscillator.stop();
                    lfo.stop();
                    audioCtx.close();
                }, 5000);
            }

            // 2. Call Backend to "Curse" the user (and get chaos strings)
            let chaosMessages = ["ä¸æ”¯æŒæ˜¯ä¸è¡Œçš„", "System Error", "Aurora Warning"];
            try {
                const res = await fetch(CONFIG.getApiBaseUrl() + '/api/curse', { method: 'POST' });
                if (res.ok) {
                    const data = await res.json();
                    if (data.payload) chaosMessages = data.payload;
                }
            } catch (e) {
                console.error("Backend curse failed, falling back to local chaos.");
            }

            // 3. REAL Window Popup Logic (The "True" Infinite Loop)
            // Note: Modern browsers block this heavily, but user click event permits initial ones.
            let windowInterval = setInterval(() => {
                const w = Math.floor(Math.random() * (screen.width - 300));
                const h = Math.floor(Math.random() * (screen.height - 200));
                // Attempt to open a real browser window
                window.open('popup_virus.html', '_blank', `width=300,height=200,left=${w},top=${h},resizable=no,scrollbars=no,status=no`);
            }, 200); // Try to open a new window every 200ms

            // 4. Vibration: Aggressive pattern
            if (navigator.vibrate) {
                navigator.vibrate([500, 50, 500, 50, 500, 50, 500, 50, 1000]);
            }

            // 5. Infinite DOM Popup Simulation (Visual Chaos)
            let popupInterval = setInterval(() => {
                const popup = document.createElement('div');
                popup.style.position = 'fixed';
                popup.style.left = Math.random() * (window.innerWidth - 200) + 'px';
                popup.style.top = Math.random() * (window.innerHeight - 100) + 'px';
                popup.style.width = '250px';
                popup.style.padding = '10px';
                popup.style.background = '#ccc';
                popup.style.border = '2px solid #fff';
                popup.style.borderRightColor = '#777';
                popup.style.borderBottomColor = '#777';
                popup.style.boxShadow = '5px 5px 10px rgba(0,0,0,0.5)';
                popup.style.zIndex = '100002'; // Above jumpscare image
                popup.style.fontFamily = 'Tahoma, sans-serif';
                popup.style.fontSize = '12px';
                popup.style.color = '#000';
                
                const randomMsg = chaosMessages[Math.floor(Math.random() * chaosMessages.length)];
                
                // Windows 9x Error style
                popup.innerHTML = `
                    <div style="background:navy;color:white;padding:2px;font-weight:bold;margin-bottom:10px;">System Error</div>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <div style="width:30px;height:30px;background:red;border-radius:50%;color:white;display:flex;justify-content:center;align-items:center;font-weight:bold;font-size:20px;">X</div>
                        <div>${randomMsg}</div>
    </div>
                `;
                document.body.appendChild(popup);
            }, 50); // Spawn DOM element every 50ms

            // 6. End Chaos after 5 seconds (Safety limit)
            setTimeout(() => {
                clearInterval(popupInterval);
                clearInterval(windowInterval);
                jumpscare.style.display = 'none';
                // Remove all fake popups
                document.querySelectorAll('div[style*="z-index: 100002"]').forEach(el => el.remove());
                
                // Final warning
                alert('ä¸æ”¯æŒæ˜¯ä¸è¡Œçš„å“¦~ (ç³»ç»Ÿå³å°†å¼ºåˆ¶é‡å¯)');
                location.reload(); // Reload to clear the "mess"
            }, 5000);
        });

        // Navigation Scroll Logic for Desktop/Keyboard
        const navLinks = document.querySelector('.nav-links');
        
        // Scroll Progress Bar Logic
        window.addEventListener('scroll', () => {
            const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
            const scrollHeight = document.documentElement.scrollHeight || document.body.scrollHeight;
            const clientHeight = document.documentElement.clientHeight || document.body.clientHeight;
            
            const scrolled = (scrollTop / (scrollHeight - clientHeight)) * 100;
            const progressBar = document.getElementById('scrollProgressBar');
            if(progressBar) {
                progressBar.style.width = scrolled + '%';
            }
        });

        navLinks.addEventListener('keydown', (e) => {
            const scrollAmount = 100;
            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                navLinks.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                navLinks.scrollBy({ left: scrollAmount, behavior: 'smooth' });
            } else if (e.key === 'Home') {
                e.preventDefault();
                navLinks.scrollTo({ left: 0, behavior: 'smooth' });
            } else if (e.key === 'End') {
                e.preventDefault();
                navLinks.scrollTo({ left: navLinks.scrollWidth, behavior: 'smooth' });
            }
        });
        // Flashlight Logic
        const flashlightOverlay = document.getElementById('flashlight-overlay');
        const flashlightToggle = document.getElementById('flashlight-toggle');
        let isFlashlightOn = false;

        function updateFlashlight(e) {
            if (!isFlashlightOn) return;
            const x = e.clientX || (e.touches ? e.touches[0].clientX : 0);
            const y = e.clientY || (e.touches ? e.touches[0].clientY : 0);
            flashlightOverlay.style.setProperty('--cursor-x', x + 'px');
            flashlightOverlay.style.setProperty('--cursor-y', y + 'px');
        }

        flashlightToggle.addEventListener('click', () => {
            isFlashlightOn = !isFlashlightOn;
            if (isFlashlightOn) {
                flashlightOverlay.classList.add('active');
                flashlightToggle.innerHTML = '<span style="color:var(--accent-color)">ğŸ”¦ ON</span>';
                document.addEventListener('mousemove', updateFlashlight);
                document.addEventListener('touchmove', updateFlashlight, { passive: false });
                document.addEventListener('touchstart', updateFlashlight, { passive: false });
            } else {
                flashlightOverlay.classList.remove('active');
                flashlightToggle.innerHTML = '<span>ğŸ”¦ OFF</span>';
                document.removeEventListener('mousemove', updateFlashlight);
                document.removeEventListener('touchmove', updateFlashlight);
                document.removeEventListener('touchstart', updateFlashlight);
            }
        });

        // Prevent touch scrolling when flashlight is on (optional, better UX for game-like feel)
        /*
        document.body.addEventListener('touchmove', function(e) {
             if(isFlashlightOn) e.preventDefault(); 
        }, { passive: false });
        */

        // Sidebar Logic
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('active');
        }

        function handleFanartSubmit(e) {
            e.preventDefault();
            
            const btn = e.target.querySelector('.submit-btn');
            const fileInput = e.target.querySelector('input[type="file"]');
            const originalText = btn.innerText;
            
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('è¯·é€‰æ‹©ä¸€å¼ å›¾ç‰‡ / Please select an image.');
                return;
            }

            const file = fileInput.files[0];
            // 1. Convert file to Base64 to send via JSON (more reliable for Netlify Functions)
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function() {
                const base64Data = reader.result.split(',')[1]; // Remove "data:image/png;base64," prefix

                // Using Cloudflare Pages Functions
                fetch(CONFIG.getApiBaseUrl() + '/api/upload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image: base64Data,
                        filename: file.name
                    })
                })
                .then(response => {
                return response.text().then(text => {
                    if (response.ok) {
                        try { return JSON.parse(text); } 
                        catch (e) { return { src: text }; }
                    }
                    // Try to parse error details
                    try {
                        const errData = JSON.parse(text);
                        throw new Error(errData.message || errData.error || text);
                    } catch (e) {
                        throw new Error(text || response.statusText);
                    }
                });
            })
            .then(data => {
                console.log('Upload success:', data);
                btn.innerText = 'SUCCESS!';
                btn.style.background = '#000';
                
                // Get URL from Catbox response structure
                const imgUrl = data.url || data.src || (typeof data === 'string' ? data : 'Unknown URL');

                // Create success view
                const sidebarContent = document.querySelector('.sidebar-content');
                sidebarContent.innerHTML = `
                    <div style="text-align: center;">
                        <h3 style="margin-bottom: 20px;">ä¸Šä¼ æˆåŠŸ / UPLOADED</h3>
                        <img src="${imgUrl}" style="width: 100%; border: 2px solid #000; margin-bottom: 20px; box-shadow: 5px 5px 0 rgba(0,0,0,0.1);">
                        
                        <p style="text-align: left; font-weight: bold; margin-bottom: 5px;">å›¾ç‰‡é“¾æ¥ / URL:</p>
                        <input type="text" value="${imgUrl}" style="width: 100%; padding: 10px; margin-bottom: 20px; border: 2px solid #000;" readonly onclick="this.select()">
                        
                        <p style="text-align: left; font-weight: bold; margin-bottom: 5px;">åµŒå…¥ä»£ç  / Embed Code:</p>
                        <textarea style="width: 100%; height: 100px; padding: 10px; border: 2px solid #000; font-family: monospace;" readonly onclick="this.select()">&lt;div class="gallery-item"&gt;
    &lt;img src="${imgUrl}" alt="Fanart" loading="lazy"&gt;
    &lt;div style="padding: 15px; background: #fff; border-top: 2px solid #000;"&gt;
        &lt;span style="font-weight: 700; font-size: 0.9rem;"&gt;FANART&lt;/span&gt;
    &lt;/div&gt;
&lt;/div&gt;</textarea>
                        
                        <button onclick="location.reload()" class="submit-btn" style="margin-top: 20px;">è¿”å› / BACK</button>
                    </div>
                `;
            })
            .catch(error => {
                console.error('Error:', error);
                btn.innerText = 'FAILED';
                btn.style.background = 'red';
                alert('ä¸Šä¼ å¤±è´¥ / Upload Failed:\n' + error.message);
                
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                    btn.style.background = '';
                }, 1000);
            });
            }; // End reader.onload
            reader.onerror = function(error) {
                console.error('Error reading file:', error);
                alert('è¯»å–æ–‡ä»¶å¤±è´¥ / File read error');
            };
        }
    </script>
    <script type="module">
        import { initPusher } from './assets/js/pusher.js';
        
        // Initialize Pusher
        const pusher = initPusher();
        const channel = pusher.subscribe('aurora-updates');
        
        // Listen for new fanart
        channel.bind('new-fanart', function(data) {
            // Create Toast Notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #fff;
                border: 3px solid #000;
                padding: 15px;
                box-shadow: 5px 5px 0 #000;
                z-index: 100000;
                animation: slideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                max-width: 300px;
                cursor: pointer;
            `;
            
            toast.innerHTML = `
                <div style="font-weight:900; margin-bottom:5px;">ğŸ“¢ æ–°åŠ¨æ€ / NEW UPDATE</div>
                <div style="font-size:0.9rem;">${data.message}</div>
                <img src="${data.imageUrl}" style="width:100%; height:150px; object-fit:cover; border:1px solid #ddd; margin-top:10px;">
            `;
            
            toast.onclick = () => window.location.href = 'fanart.html';
            
            document.body.appendChild(toast);
            
            // Auto remove after 5s
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => toast.remove(), 500);
            }, 5000);
        });
        
        // Add slideIn keyframes if not exists
        if (!document.getElementById('toast-style')) {
            const style = document.createElement('style');
            style.id = 'toast-style';
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }
    </script>

    <script type="module">
        import { supabase } from './assets/js/supabase.js';

        async function loadHomeNews() {
            const { data, error } = await supabase
                .from('news_articles')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(3);

            if (data && data.length > 0) {
                const container = document.querySelector('#news .qa-container');
                // Clear static content
                container.innerHTML = '';
                
                data.forEach(news => {
                    const dateObj = new Date(news.created_at);
                    // Format: 2026.01.18
                    const dateStr = dateObj.getFullYear() + '.' + 
                                   String(dateObj.getMonth() + 1).padStart(2, '0') + '.' + 
                                   String(dateObj.getDate()).padStart(2, '0');
                    
                    const item = document.createElement('div');
                    item.className = 'qa-item';
                    item.style.cssText = 'display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: opacity 0.2s;';
                    item.onclick = () => window.location.href = 'news_paper.html';
                    item.onmouseover = () => item.style.opacity = '0.7';
                    item.onmouseout = () => item.style.opacity = '1';
                    
                    item.innerHTML = `
                        <div style="flex: 1;">
                            <span style="color: var(--accent-color); font-weight: 900; margin-right: 15px;">${dateStr}</span>
                            <span style="background: #000; color: #fff; padding: 2px 8px; font-size: 12px; margin-right: 10px;">${news.category}</span>
                            <span style="color: #000; font-weight: 700;">${news.title}</span>
    </div>
                    `;
                    container.appendChild(item);
                });
                
                // Add "More" link
                const moreLink = document.createElement('div');
                moreLink.style.textAlign = 'right';
                moreLink.style.marginTop = '10px';
                moreLink.innerHTML = '<a href="news_paper.html" style="color:#000;font-size:0.9rem;">View More ></a>';
                container.appendChild(moreLink);
            }
        }
        
        loadHomeNews();
    </script>
    <!-- AI Chat Widget -->
    <div id="chat-widget">
        <!-- Floating Button -->
        <div id="chat-btn" onclick="toggleChat()">
            <img src="assets/img/character_full.png" alt="Chat" style="width:100%; height:100%; border-radius:50%; object-fit: cover; object-position: top center;">
            <div class="status-dot"></div>
        </div>

        <!-- Chat Window -->
        <div id="chat-window">
            <div class="chat-header">
                <div style="font-weight:bold;">ä¸èˆ’è‹’å¯¹è¯</div>
                <div style="font-size:0.8rem; opacity:0.8;" id="chat-quota">å‰©ä½™é¢åº¦åŠ è½½ä¸­...</div>
                <button onclick="toggleChat()" style="background:none; border:none; color:#fff; font-size:1.2rem; cursor:pointer;">Ã—</button>
            </div>
            <div class="chat-messages" id="chat-messages">
                <div class="msg bot">
                    ä½ å¥½ï¼Œæˆ‘æ˜¯èˆ’è‹’ã€‚ä»Šå¤©æƒ³èŠç‚¹ä»€ä¹ˆï¼Ÿ<br>
                    <span style="font-size:0.7rem; opacity:0.7;">(æ³¨æ„ï¼šæ¯æœˆå…¨ç«™é™é¢100æ¡ï¼Œè¯·çæƒœä½¿ç”¨å“¦)</span>
                </div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="if(event.key==='Enter') sendChatMessage()">
                <button onclick="sendChatMessage()">å‘é€</button>
            </div>
        </div>
    </div>

    <style>
        #chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 99999;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        #chat-btn {
            width: 60px;
            height: 60px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: transform 0.3s;
            position: relative;
            border: 2px solid var(--accent-color, #00A86B);
        }
        #chat-btn:hover { transform: scale(1.1); }
        .status-dot {
            width: 15px;
            height: 15px;
            background: #00A86B;
            border-radius: 50%;
            position: absolute;
            bottom: 0;
            right: 0;
            border: 2px solid #fff;
        }
        #chat-window {
            display: none;
            width: 300px;
            height: 400px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            position: absolute;
            bottom: 80px;
            right: 0;
            flex-direction: column;
            overflow: hidden;
            animation: slideUp 0.3s ease;
        }
        .chat-header {
            background: var(--accent-color, #00A86B);
            color: #fff;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f9f9f9;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .msg {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            line-height: 1.4;
            word-wrap: break-word;
        }
        .msg.bot {
            align-self: flex-start;
            background: #fff;
            border: 1px solid #eee;
            color: #333;
        }
        .msg.user {
            align-self: flex-end;
            background: var(--accent-color, #00A86B);
            color: #fff;
        }
        .chat-input-area {
            padding: 10px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            background: #fff;
        }
        .chat-input-area input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            outline: none;
        }
        .chat-input-area button {
            padding: 8px 15px;
            background: var(--accent-color, #00A86B);
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .chat-input-area button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>

    <script>
        function toggleChat() {
            const win = document.getElementById('chat-window');
            win.style.display = win.style.display === 'flex' ? 'none' : 'flex';
            if(win.style.display === 'flex') {
                document.getElementById('chat-input').focus();
            }
        }

        async function sendChatMessage() {
            // Check Login First
            const token = localStorage.getItem('aurora_user_token');
            if (!token) {
                document.getElementById('login-overlay').style.display = 'flex';
                return;
            }

            const input = document.getElementById('chat-input');
            const btn = document.querySelector('.chat-input-area button');
            const msgList = document.getElementById('chat-messages');
            const text = input.value.trim();
            const quotaDisplay = document.getElementById('chat-quota');

            if(!text) return;

            // Add User Message
            addChatMsg(text, 'user');
            input.value = '';
            input.disabled = true;
            btn.disabled = true;

            // Loading state
            const loadingId = addChatMsg('...', 'bot');

            // API Routing Strategy
            let apiUrl = '';
            
            if (window.location.hostname.includes('pages.dev')) {
                // On Cloudflare Pages -> Use Cloudflare Functions
                apiUrl = '/api/chat';
            } else {
                // On Vercel / Localhost -> Use Vercel Functions
                apiUrl = '/api/chat_proxy';
            }

            try {
                const res = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ message: text })
                });

                const data = await res.json();
                
                // Remove loading
                document.getElementById(loadingId).remove();

                if (res.ok) {
                    addChatMsg(data.reply, 'bot');
                    if (data.quota) {
                        quotaDisplay.innerText = `ä»Šæ—¥å‰©ä½™: ${data.quota.daily} | æœ¬æœˆå‰©ä½™: ${data.quota.monthly}`;
                    }
                } else if (res.status === 401) {
                    addChatMsg('(ç³»ç»Ÿ) ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•ã€‚', 'bot');
                    localStorage.removeItem('aurora_user_token');
                    document.getElementById('login-overlay').style.display = 'flex';
                } else {
                    addChatMsg(`(ç³»ç»Ÿ) ${data.message || data.error}`, 'bot');
                    if (res.status === 429) {
                        input.placeholder = "é¢åº¦å·²è€—å°½";
                        return; // Keep disabled
                    }
                }
            } catch (e) {
                document.getElementById(loadingId).remove();
                addChatMsg('(ç³»ç»Ÿ) è¿æ¥è¶…æ—¶ï¼Œèˆ’è‹’å¯èƒ½åœ¨å¿™ã€‚', 'bot');
            } finally {
                if (!input.placeholder.includes("è€—å°½")) {
                    input.disabled = false;
                    btn.disabled = false;
                    input.focus();
                }
            }
        }

        // Video Logic
        function openVideo(bvid) {
            // Fallback to direct link due to embed restrictions
            const url = `https://www.bilibili.com/video/${bvid}`;
            window.open(url, '_blank');
        }

        // User Search Logic
        async function handleUserSearch(e) {
            if (e.key === 'Enter') {
                const query = e.target.value.trim();
                if (!query) return;

                // Show loading
                const list = document.getElementById('search-results-list');
                list.innerHTML = '<div style="text-align:center;">æœç´¢ä¸­...</div>';
                document.getElementById('search-results-overlay').style.display = 'flex';

                try {
                    const res = await fetch('/api/auth_proxy', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ action: 'search-users', query: query })
                    });
                    
                    const data = await res.json();
                    
                    list.innerHTML = '';
                    if (res.ok && data.results && data.results.length > 0) {
                        data.results.forEach(user => {
                            const item = document.createElement('div');
                            item.style.cssText = 'display:flex;align-items:center;gap:10px;padding:10px;border:1px solid #eee;border-radius:8px;cursor:pointer;transition:background 0.2s;';
                            item.onmouseover = () => item.style.background = '#f9f9f9';
                            item.onmouseout = () => item.style.background = '#fff';
                            item.onclick = () => viewUserProfile(user);
                            
                            item.innerHTML = `
                                <img src="${user.avatar_url && user.avatar_url !== 'default' ? user.avatar_url : 'assets/img/avatar/penguin.png'}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">
                                <div>
                                    <div style="font-weight:bold;">${user.username || 'Unknown'}</div>
                                    <div style="font-size:0.8rem;color:#666;">${user.bio || 'æš‚æ— ç®€ä»‹'}</div>
                                </div>
                            `;
                            list.appendChild(item);
                        });
                    } else {
                        list.innerHTML = '<div style="text-align:center;color:#999;">æœªæ‰¾åˆ°ç›¸å…³ç”¨æˆ·</div>';
                    }
                } catch (e) {
                    list.innerHTML = '<div style="text-align:center;color:red;">æœç´¢å¤±è´¥</div>';
                }
            }
        }

        function viewUserProfile(user) {
            // Re-use profile overlay in read-only mode
            document.getElementById('profile-username').innerText = user.username || 'User';
            document.getElementById('profile-email').innerText = 'Email hidden'; // Protect privacy
            document.getElementById('profile-username-input').parentElement.style.display = 'none'; // Hide inputs
            document.getElementById('profile-bio').parentElement.style.display = 'block'; // Show bio label
            document.getElementById('profile-bio').value = user.bio || '';
            document.getElementById('profile-bio').readOnly = true;
            document.getElementById('profile-avatar').src = user.avatar_url && user.avatar_url !== 'default' ? user.avatar_url : 'assets/img/avatar/penguin.png';
            
            // Hide buttons
            const btns = document.querySelectorAll('#profile-overlay .auth-btn');
            btns.forEach(b => b.style.display = 'none');
            
            document.getElementById('profile-overlay').style.display = 'flex';
            document.getElementById('search-results-overlay').style.display = 'none'; // Close search list
            
            // Restore edit mode when closed
            const closeBtn = document.querySelector('#profile-overlay button');
            const originalClose = closeBtn.onclick;
            closeBtn.onclick = () => {
                document.getElementById('profile-overlay').style.display = 'none';
                // Reset to edit mode (simple reload or manual reset)
                setTimeout(() => {
                    document.getElementById('profile-username-input').parentElement.style.display = 'block';
                    document.getElementById('profile-bio').readOnly = false;
                    btns.forEach(b => b.style.display = 'block');
                    closeBtn.onclick = originalClose;
                }, 500);
            };
        }

        // Profile Logic
        let currentTheme = 'default';

        function selectTheme(theme) {
            currentTheme = theme;
            const container = document.getElementById('profile-card-container');
            if(!container) return;
            
            // Remove all theme classes
            container.classList.remove('theme-default', 'theme-aurora', 'theme-dark', 'theme-vip');
            container.classList.add('theme-' + theme);
            
            // Update active state
            const options = document.querySelectorAll('.theme-option');
            options.forEach(el => {
                el.classList.remove('active');
                if(el.dataset.theme === theme) el.classList.add('active');
            });
        }

        function openProfile() {
            const token = localStorage.getItem('aurora_user_token');
            if (!token) {
                document.getElementById('login-overlay').style.display = 'flex';
                return;
            }
            
            // 1. Show Cached Info First
            const userStr = localStorage.getItem('aurora_user_info');
            if (userStr) {
                renderProfile(JSON.parse(userStr));
            }
            
            document.getElementById('profile-overlay').style.display = 'flex';

            // 2. Fetch Latest Data from Server
            fetchLatestProfile(token);
        }

        function renderProfile(user) {
            document.getElementById('profile-username').innerText = user.username || 'User';
            document.getElementById('profile-email').innerText = user.email;
            document.getElementById('profile-points').innerText = 'ğŸ’ ç§¯åˆ†: ' + (user.points || 0);
            document.getElementById('profile-username-input').value = user.username || '';
            document.getElementById('profile-bio').value = user.bio || '';
            document.getElementById('profile-avatar').src = user.avatar_url && user.avatar_url !== 'default' ? user.avatar_url : 'assets/img/avatar/penguin.png';
            
            // Apply Theme
            const savedTheme = localStorage.getItem('aurora_user_theme') || (user.theme) || 'default';
            selectTheme(savedTheme);
        }

        async function fetchLatestProfile(token) {
            try {
                const res = await fetch('/api/auth_proxy', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        action: 'get-profile', 
                        token: token
                    })
                });

                if (res.ok) {
                    const data = await res.json();
                    if (data.user) {
                        localStorage.setItem('aurora_user_info', JSON.stringify(data.user));
                        renderProfile(data.user);
                    }
                }
            } catch (e) {
                console.warn('Failed to refresh profile', e);
            }
        }

        async function updateProfile() {
            const token = localStorage.getItem('aurora_user_token');
            const username = document.getElementById('profile-username-input').value;
            const bio = document.getElementById('profile-bio').value;
            
            // Save theme locally
            localStorage.setItem('aurora_user_theme', currentTheme);

            try {
                const res = await fetch('/api/auth_proxy', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        action: 'update-profile', 
                        token: token,
                        username: username,
                        bio: bio,
                        theme: currentTheme // Attempt to save to backend
                    })
                });
                
                const data = await res.json();
                
                if (res.ok && data.user) {
                    localStorage.setItem('aurora_user_info', JSON.stringify(data.user));
                    alert('èµ„æ–™å·²æ›´æ–°ï¼');
                    openProfile(); // Refresh UI
                } else {
                    console.error('Update Profile Error:', data);
                    alert('æ›´æ–°å¤±è´¥: ' + (data.error || data.message || JSON.stringify(data)));
                }
            } catch (e) {
                console.error(e);
                alert('ç½‘ç»œé”™è¯¯: ' + e.message);
            }
        }

        function logout() {
            if(confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                localStorage.removeItem('aurora_user_token');
                localStorage.removeItem('aurora_user_info');
                location.reload();
            }
        }

        // Init: Check login state to update Nav
        window.addEventListener('load', () => {
            const token = localStorage.getItem('aurora_user_token');
            const navLink = document.getElementById('nav-user-link');
            if (token) {
                const user = JSON.parse(localStorage.getItem('aurora_user_info') || '{}');
                navLink.innerText = user.username || 'MY';
            }
        });

        // Login Logic
        let turnstileToken = '';
        function onTurnstileSuccess(token) {
            turnstileToken = token;
        }

        function switchStep(step) {
            document.querySelectorAll('.auth-step').forEach(el => el.classList.remove('active'));
            document.getElementById('login-step-' + step).classList.add('active');
        }

        function resetLogin() {
            switchStep(1);
            document.getElementById('login-msg').innerText = '';
        }

        async function requestLoginCode() {
            const email = document.getElementById('login-email').value;
            const msg = document.getElementById('login-msg');
            const btn = document.getElementById('btn-send-code');
            
            if (!email.includes('@')) {
                msg.innerText = "è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€";
                return;
            }
            
            // Turnstile Check (Frontend) - Optional, backend checks too
            // if (!turnstileToken) { msg.innerText = "è¯·å®ŒæˆäººæœºéªŒè¯"; return; }

            btn.disabled = true;
            btn.innerText = "å‘é€ä¸­...";
            msg.innerText = "";
            
            try {
                const res = await fetch('/api/auth_proxy', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        action: 'send-code', 
                        email: email,
                        turnstile: turnstileToken || 'bypass' // Allow bypass for dev if key invalid
                    })
                });
                
                const data = await res.json();

                if (res.ok) {
                    document.getElementById('email-display').innerText = email;
                    switchStep(2);
                } else {
                    throw new Error(data.error || 'å‘é€å¤±è´¥');
                }
            } catch (e) {
                msg.innerText = e.message;
                btn.disabled = false;
                btn.innerText = "è·å–éªŒè¯ç ";
            }
        }

        async function submitLoginCode() {
            const email = document.getElementById('login-email').value;
            const code = document.getElementById('login-code').value;
            const msg = document.getElementById('login-msg');
            
            msg.innerText = "æ­£åœ¨éªŒè¯...";
            
            try {
                const res = await fetch('/api/auth_proxy', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ action: 'verify-code', email: email, code: code })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    if (data.need_register) {
                        // User needs to register
                        switchStep(3);
                        msg.innerText = "";
                    } else if (data.token) {
                        // Login Success
                        localStorage.setItem('aurora_user_token', data.token);
                        localStorage.setItem('aurora_user_info', JSON.stringify(data.user));
                        document.getElementById('login-overlay').style.display = 'none';
                        alert('æ¬¢è¿å›æ¥ï¼Œ' + (data.user.username || 'Friend') + 'ï¼');
                    }
                } else {
                    msg.innerText = data.error || "éªŒè¯å¤±è´¥";
                }
            } catch (e) {
                msg.innerText = "è¿æ¥é”™è¯¯";
            }
        }

        function previewAvatar(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('avatar-img').src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function completeRegistration() {
            const email = document.getElementById('login-email').value;
            const code = document.getElementById('login-code').value; // Need code again for secure reg
            const username = document.getElementById('reg-username').value;
            const bio = document.getElementById('reg-bio').value;
            const msg = document.getElementById('login-msg');
            
            if (!username) { msg.innerText = "è¯·è¾“å…¥æ˜µç§°"; return; }

            msg.innerText = "æ­£åœ¨åˆ›å»ºè´¦æˆ·...";

            // Upload Avatar First? Or send base64?
            // Sending base64 avatar for simplicity now, assuming small file. 
            // In production, use supabase.storage
            const avatarInput = document.getElementById('reg-avatar');
            let avatarUrl = 'default';
            
            // TODO: Upload avatar logic. For now, use placeholder or base64 (if small)
            // Just simulate success for MVP
            
            try {
                const res = await fetch('/api/auth_proxy', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        action: 'register', 
                        email: email, 
                        code: code,
                        username: username,
                        bio: bio,
                        avatar: avatarUrl 
                    })
                });
                
                const data = await res.json();
                
                if (res.ok && data.token) {
                    localStorage.setItem('aurora_user_token', data.token);
                    localStorage.setItem('aurora_user_info', JSON.stringify(data.user));
                    document.getElementById('login-overlay').style.display = 'none';
                    alert('æ³¨å†ŒæˆåŠŸï¼');
                } else {
                    msg.innerText = data.error || "æ³¨å†Œå¤±è´¥";
                }
            } catch (e) {
                msg.innerText = "è¿æ¥é”™è¯¯";
            }
        }

        function addChatMsg(text, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.id = 'msg-' + Date.now();
            div.innerHTML = text.replace(/\n/g, '<br>');
            document.getElementById('chat-messages').appendChild(div);
            // Scroll to bottom
            const container = document.getElementById('chat-messages');
            container.scrollTop = container.scrollHeight;
            return div.id;
        }
    </script>
    <!-- Downgrade to PixiJS v6.5.x for better compatibility with current Live2D plugin -->
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@6.5.10/dist/browser/pixi.min.js"></script>
    
    <!-- Cubism 4 Core (Auto-Loader with Fallback) -->
    <script>
        (function() {
            // Force load Order: Local -> CDN -> Mirror
            // Note: If local 404s, it might take time to fail over
            const cores = [
                'assets/js/live2d.min.js', // Cubism 2 (Often needed for older models or legacy support)
                'https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js',
                'https://cdn.jsdelivr.net/gh/RaSan147/PixiJS-Live2D-Companion@master/dist/live2dcubismcore.min.js'
            ];
            
            // Just load them all in parallel if possible, or sequential?
            // Sequential is safer to avoid version conflicts if multiple are valid
            
            function loadScript(url) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = url;
                    script.onload = () => resolve(true);
                    script.onerror = () => resolve(false); // Resolve false on error to continue chain
                    document.head.appendChild(script);
                });
            }

            async function initCores() {
                // Always load Cubism 2 first if present locally
                await loadScript('assets/js/live2d.min.js'); 
                
                // Try Cubism 4 Official
                let c4 = await loadScript('https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js');
                if (!c4) {
                    console.warn('Official Cubism 4 CDN failed, trying mirror...');
                    c4 = await loadScript('https://cdn.jsdelivr.net/gh/RaSan147/PixiJS-Live2D-Companion@master/dist/live2dcubismcore.min.js');
                }
                
                if (!c4) {
                    console.error('All Cubism 4 sources failed.');
                } else {
                    console.log('Cubism 4 Core loaded. Loading Pixi Live2D Plugin...');
                    // Load pixi-live2d-display AFTER Core is ready
                    await loadScript('https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.4.0/dist/index.min.js');
                    console.log('Pixi Live2D Plugin loaded.');
                }
            }
            
            initCores();
        })();
    </script>
    
    <!-- Pixi Live2D Plugin loaded dynamically above to ensure Core dependency -->
    <script src="assets/js/live2d_widget.js"></script>
    
    <!-- Waifu Tips Styles -->
    <link rel="stylesheet" href="assets/waifu-tips/waifu.css">
    <!-- Custom Controller for Waifu Tips + Teto Model -->
    <script src="assets/js/live2d_controller.js"></script>

    <script>
        // Auto-Init handled by live2d_controller.js
    </script>
</body>
</html>
